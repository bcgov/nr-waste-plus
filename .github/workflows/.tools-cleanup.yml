name: Tools environment cleanup

on:
  workflow_call:

permissions: {}

jobs:
  tools-cleanup:
    name: Cleanup tools environment
    environment: tools
    runs-on: ubuntu-24.04
    steps:
      - name: Scale down legacy
        continue-on-error: true
        uses: bcgov/action-oc-runner@f900830adadd4d9eef3ca6ff80103e839ba8b7c0 # v1.3.0
        with:
          oc_namespace: ${{ secrets.oc_namespace }}
          oc_token: ${{ secrets.oc_token }}
          oc_server: ${{ secrets.oc_server }}
          commands: |
            oc scale deployment/nr-waste-plus-${{ github.event.number }}-legacy --replicas=0 -n ${{ secrets.OC_NAMESPACE }}
            undesired_replicas=0

            while true; do
              available_replicas=$(oc get deployment/nr-waste-plus-${{ github.event.number }}-legacy -n ${{ secrets.OC_NAMESPACE }} -o jsonpath='{.status.availableReplicas}')
              if [[ "$available_replicas" -ge "$undesired_replicas" ]]; then
                break
              fi
              sleep 5
            done

      - name: Remove the PR database
        continue-on-error: true
        run: |
          for i in {1..5}; do
            POD_NAME=$(oc get pods -l app=nr-waste-plus-tools-db -o jsonpath='{.items[0].metadata.name}' 2>/dev/null)
            if [ -n "$POD_NAME" ]; then
              echo "Using Oracle DB pod: $POD_NAME"
              oc exec $POD_NAME -- /opt/oracle/removeDatabase "THE" "PR_${{ github.event.number }}"
              break
            fi
            sleep 10
          done

      - name: Remove PR-specific Oracle service
        continue-on-error: true
        run: |
          PR_NUMBER="${{ github.event.number }}"

          POD_NAME=$(oc get pods -l app=nr-waste-plus-tools-db -o jsonpath='{.items[0].metadata.name}')

          if [ -z "$POD_NAME" ]; then
            echo "ERROR: Oracle DB pod not found"
            exit 1
          fi

          echo "Removing Oracle service PR_$PR_NUMBER from $POD_NAME"

          oc exec "$POD_NAME" -- bash -c "sqlplus / as sysdba <<SQL
          BEGIN
            DBMS_SERVICE.DELETE_SERVICE(service_name => 'PR_$PR_NUMBER');
          END;
          /
          ALTER SYSTEM REGISTER;
          SQL"

          echo "Remaining PR services:"
          oc exec "$POD_NAME" -- bash -c "sqlplus / as sysdba <<'SQL'
          SELECT name FROM v$services WHERE name LIKE 'PR_%';
          SQL
          "

      - name: Stop PR-specific CronJobs and clean PR resources
        continue-on-error: true
        run: |
          NS="${{ secrets.oc_namespace }}"
          PR_NUMBER="${{ github.event.number }}"
          oc project "$NS"

          oc delete job -l pr=$PR_NUMBER || true
          oc delete pod -l pr=$PR_NUMBER || true
          oc delete all,pvc,secret,cm -l pr=$PR_NUMBER || true
