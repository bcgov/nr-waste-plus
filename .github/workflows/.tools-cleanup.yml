name: Tools environment cleanup

on:
  workflow_call:

permissions: {}

jobs:
  tools-cleanup:
    name: Cleanup tools environment
    environment: tools
    runs-on: ubuntu-24.04

    steps:
      - name: Scale down legacy
        continue-on-error: true
        uses: bcgov/action-oc-runner@f900830adadd4d9eef3ca6ff80103e839ba8b7c0 # v1.3.0
        with:
          oc_namespace: ${{ secrets.oc_namespace }}
          oc_token: ${{ secrets.oc_token }}
          oc_server: ${{ secrets.oc_server }}
          commands: |
            NS="${{ secrets.oc_namespace }}"
            DEPLOYMENT="nr-waste-plus-${{ github.event.number }}-legacy"

            echo "Checking for legacy deployment $DEPLOYMENT in $NS..."

            if oc get deployment "$DEPLOYMENT" -n "$NS" > /dev/null 2>&1; then
              echo "Scaling $DEPLOYMENT to 0 replicas"
              oc scale deployment "$DEPLOYMENT" --replicas=0 -n "$NS"
            else
              echo "Legacy deployment not found â€” skipping scale down"
            fi

      - name: Remove PR database and Oracle service
        continue-on-error: true
        uses: bcgov/action-oc-runner@f900830adadd4d9eef3ca6ff80103e839ba8b7c0
        with:
          oc_namespace: ${{ secrets.oc_namespace }}
          oc_token: ${{ secrets.oc_token }}
          oc_server: ${{ secrets.oc_server }}
          commands: |
            NS="${{ secrets.oc_namespace }}"
            PR_NUMBER="${{ github.event.number }}"

            echo "Locating Oracle DB pod..."
            POD_NAME=$(oc get pods -n "$NS" \
              -l app=nr-waste-plus-tools \
              -l deployment=nr-waste-plus-tools-legacydb \
              -o name | head -n1 | sed 's|pod/||')

            if [ -z "$POD_NAME" ]; then
              echo "WARNING: Oracle DB pod not found in namespace $NS. Skipping DB cleanup."
              oc get pods -n "$NS"
            else
              echo "Using Oracle DB pod: $POD_NAME"

              echo "Dropping PDB PR_$PR_NUMBER"
              oc exec -n "$NS" "$POD_NAME" -c nr-waste-plus -- \
                /opt/oracle/removeDatabase "THE" "PR_$PR_NUMBER" || true

              echo "Deleting Oracle service PR_$PR_NUMBER"
              oc exec -n "$NS" "$POD_NAME" -c nr-waste-plus -- sqlplus / as sysdba <<EOF || true
              BEGIN
                DBMS_SERVICE.DELETE_SERVICE(service_name => 'PR_$PR_NUMBER');
              EXCEPTION
                WHEN OTHERS THEN NULL;
              END;
              /
              ALTER SYSTEM REGISTER;
              EXIT;
              EOF

              echo "Remaining PR services:"
              oc exec -n "$NS" "$POD_NAME" -c nr-waste-plus -- sqlplus / as sysdba <<EOF || true
              SELECT name FROM v\\$services WHERE name LIKE 'PR_%';
              EXIT;
              EOF
            fi

      - name: Stop PR-specific CronJobs and clean PR resources
        continue-on-error: true
        uses: bcgov/action-oc-runner@f900830adadd4d9eef3ca6ff80103e839ba8b7c0
        with:
          oc_namespace: ${{ secrets.oc_namespace }}
          oc_token: ${{ secrets.oc_token }}
          oc_server: ${{ secrets.oc_server }}
          commands: |
            NS="${{ secrets.oc_namespace }}"
            PR_NUMBER="${{ github.event.number }}"

            echo "Deleting PR=$PR_NUMBER resources in $NS"

            oc delete job -l pr="$PR_NUMBER" || true
            oc delete pod -l pr="$PR_NUMBER" || true
            oc delete all,pvc,secret,cm -l pr="$PR_NUMBER" || true
