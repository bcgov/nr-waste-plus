name: Tools environment cleanup

on:
  workflow_call:

permissions: {}

jobs:
  tools-cleanup:
    name: Cleanup tools environment
    environment: tools
    runs-on: ubuntu-24.04
    steps:
      - name: Scale down legacy
        continue-on-error: true
        uses: bcgov/action-oc-runner@f900830adadd4d9eef3ca6ff80103e839ba8b7c0 # v1.3.0
        with:
          oc_namespace: ${{ secrets.oc_namespace }}
          oc_token: ${{ secrets.oc_token }}
          oc_server: ${{ secrets.oc_server }}
          commands: |
            oc scale deployment/nr-waste-plus-${{ github.event.number }}-legacy --replicas=0 -n ${{ secrets.OC_NAMESPACE }}
            undesired_replicas=0

            while true; do
              available_replicas=$(oc get deployment/nr-waste-plus-${{ github.event.number }}-legacy -n ${{ secrets.OC_NAMESPACE }} -o jsonpath='{.status.availableReplicas}')

              if [[ "$available_replicas" -ge "$undesired_replicas" ]]; then
                echo "DeploymentConfig ${{ secrets.OC_NAMESPACE }}-${{ github.event.number }}-legacy is now available with $available_replicas replicas."
                break
              fi

              echo "Waiting... ($available_replicas pods available)"
              sleep 5
            done

      - name: Remove the PR database
        continue-on-error: true
        run: |
          # This removes a new pluggable database and user for the PR
          for i in {1..5}; do
            POD_NAME=$(oc get pods -l app=nr-waste-plus-tools -l deployment=nr-waste-plus-tools-legacydb -o jsonpath='{.items[0].metadata.name}' 2>/dev/null)
            if [ -n "$POD_NAME" ]; then
              echo "Pod found: $POD_NAME"
              oc exec $POD_NAME -- /opt/oracle/removeDatabase "THE" "PR_${{ github.event.number }}"
              break
            else
              echo "Pod not found, retrying in 10 seconds... ($i/5)"
              sleep 10
            fi
          done

          if [ -z "$POD_NAME" ]; then
            echo "Failed to find the pod after 5 attempts."
          fi

      - name: Remove PR-specific Oracle service
        continue-on-error: true
        run: |
          PR_NUMBER="${{ github.event.number }}"
          for i in {1..5}; do
            POD_NAME=$(oc get pods -l app=nr-waste-plus-tools -l deployment=nr-waste-plus-tools-legacydb -o jsonpath='{.items[0].metadata.name}' 2>/dev/null)
            if [ -n "$POD_NAME" ]; then
              echo "Removing Oracle service PR_$PR_NUMBER from pod $POD_NAME"
              oc exec $POD_NAME -- sqlplus / as sysdba <<EOF
BEGIN
  DBMS_SERVICE.DELETE_SERVICE(service_name => 'PR_$PR_NUMBER');
END;
/
ALTER SYSTEM REGISTER;
EXIT;
EOF
              break
            else
              echo "Pod not found, retrying in 10 seconds... ($i/5)"
              sleep 10
            fi
          done

          if [ -z "$POD_NAME" ]; then
            echo "Failed to find the pod to remove Oracle service after 5 attempts."
          fi

      - name: Stop PR-specific CronJobs and clean PR resources
        continue-on-error: true
        run: |
          NS="${{ secrets.oc_namespace }}"
          PR_NUMBER="${{ github.event.number }}"
          oc project "$NS"

          echo "Stopping CronJobs related to PR_$PR_NUMBER"
          CRONJOBS=$(oc get cronjob -n "$NS" -l app=nr-waste-plus-tools \
            -o jsonpath='{.items[?(@.metadata.name=="nr-waste-plus-tools-migratedb")].metadata.name}')
          for CJ in $CRONJOBS; do
            # Only stop the cronjob if it targets this PR
            oc patch cronjob "$CJ" -p '{"spec":{"suspend":true}}'
          done

          echo "Deleting PR-specific Jobs and Pods"
          oc delete job -l pr=$PR_NUMBER || true
          oc delete pod -l pr=$PR_NUMBER || true

          echo "Deleting PR-specific resources"
          oc delete all,pvc,secret,cm -l pr=$PR_NUMBER || true
