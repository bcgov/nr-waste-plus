name: Tools environment cleanup

on:
  workflow_call:

permissions: {}

jobs:
  tools-cleanup:
    name: Cleanup tools environment
    environment: tools
    runs-on: ubuntu-24.04
    steps:
      - name: Scale down legacy
        continue-on-error: true
        uses: bcgov/action-oc-runner@f900830adadd4d9eef3ca6ff80103e839ba8b7c0 # v1.3.0
        with:
          oc_namespace: ${{ secrets.oc_namespace }}
          oc_token: ${{ secrets.oc_token }}
          oc_server: ${{ secrets.oc_server }}
          commands: |
            oc scale deployment/nr-waste-plus-${{ github.event.number }}-legacy --replicas=0 -n ${{ secrets.OC_NAMESPACE }}
            undesired_replicas=0

            while true; do
              available_replicas=$(oc get deployment/nr-waste-plus-${{ github.event.number }}-legacy -n ${{ secrets.OC_NAMESPACE }} -o jsonpath='{.status.availableReplicas}')
              if [[ "$available_replicas" -ge "$undesired_replicas" ]]; then
                break
              fi
              sleep 5
            done

      - name: Remove PR database
        continue-on-error: true
        run: |
          NS="${{ secrets.oc_namespace }}"
          PR_NUMBER="${{ github.event.number }}"
          oc project "$NS"

          echo "Locating Oracle DB pod..."
          POD_NAME=$(oc get pods -n "$NS" --no-headers | awk '/oracle|legacydb|xe|db/ && /Running/ {print $1; exit}')

          if [ -z "$POD_NAME" ]; then
            echo "ERROR: No Oracle DB pod found in namespace $NS"
            oc get pods
            exit 0
          fi

          echo "Using Oracle pod: $POD_NAME"
          echo "Dropping PDB PR_$PR_NUMBER"
          oc exec -n "$NS" "$POD_NAME" -- /opt/oracle/removeDatabase "THE" "PR_$PR_NUMBER" || true

      - name: Remove PR-specific Oracle service
        continue-on-error: true
        run: |
          NS="${{ secrets.oc_namespace }}"
          PR_NUMBER="${{ github.event.number }}"
          oc project "$NS"

          echo "Locating Oracle DB pod..."
          POD_NAME=$(oc get pods -n "$NS" --no-headers | awk '/oracle|legacydb|xe|db/ && /Running/ {print $1; exit}')

          if [ -z "$POD_NAME" ]; then
            echo "ERROR: No Oracle DB pod found in namespace $NS"
            oc get pods
            exit 0
          fi

          echo "Using Oracle pod: $POD_NAME"
          echo "Deleting Oracle service PR_$PR_NUMBER"

          oc exec -n "$NS" "$POD_NAME" -- sqlplus / as sysdba <<EOF
          BEGIN
            DBMS_SERVICE.DELETE_SERVICE(service_name => 'PR_$PR_NUMBER');
          EXCEPTION
            WHEN OTHERS THEN NULL;
          END;
          /
          ALTER SYSTEM REGISTER;
          EXIT;
          EOF

          echo "Remaining PR services:"
          oc exec -n "$NS" "$POD_NAME" -- sqlplus / as sysdba <<EOF
          SELECT name FROM v\\$services WHERE name LIKE 'PR_%';
          EXIT;
          EOF

      - name: Stop PR-specific CronJobs and clean PR resources
        continue-on-error: true
        run: |
          NS="${{ secrets.oc_namespace }}"
          PR_NUMBER="${{ github.event.number }}"
          oc project "$NS"

          oc delete job -l pr=$PR_NUMBER || true
          oc delete pod -l pr=$PR_NUMBER || true
          oc delete all,pvc,secret,cm -l pr=$PR_NUMBER || true
